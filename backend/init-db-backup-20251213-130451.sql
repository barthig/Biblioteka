\set ON_ERROR_STOP on
\echo 'Creating schema and demo data for Biblioteka...'
-- ============================================
-- Pełna struktura bazy danych systemu bibliotecznego
-- Data aktualizacji: 2025-12-13
-- System: Biblioteka - System Zarządzania Biblioteką
-- Wersja: 2.0.0
-- 
-- NOWE FUNKCJONALNOŚCI:
-- - System ocen książek (rating)
-- - System feedbacku rekomendacji (recommendation_feedback)
-- - Kolekcje kuratorskie (book_collection)
-- - Onboarding użytkownika (preferred_categories)
-- ============================================

-- ============================================
-- CZYSZCZENIE POPRZEDNIEJ STRUKTURY
-- ============================================

DROP TABLE IF EXISTS recommendation_feedback CASCADE;
DROP TABLE IF EXISTS collection_books CASCADE;
DROP TABLE IF EXISTS book_collection CASCADE;
DROP TABLE IF EXISTS rating CASCADE;
DROP TABLE IF EXISTS weeding_record CASCADE;
DROP TABLE IF EXISTS supplier CASCADE;
DROP TABLE IF EXISTS registration_token CASCADE;
DROP TABLE IF EXISTS acquisition_expense CASCADE;
DROP TABLE IF EXISTS acquisition_order CASCADE;
DROP TABLE IF EXISTS acquisition_budget CASCADE;
DROP TABLE IF EXISTS review CASCADE;
DROP TABLE IF EXISTS system_setting CASCADE;
DROP TABLE IF EXISTS staff_role CASCADE;
DROP TABLE IF EXISTS notification_log CASCADE;
DROP TABLE IF EXISTS integration_config CASCADE;
DROP TABLE IF EXISTS fine CASCADE;
DROP TABLE IF EXISTS reservation CASCADE;
DROP TABLE IF EXISTS loan CASCADE;
DROP TABLE IF EXISTS backup_record CASCADE;
DROP TABLE IF EXISTS audit_logs CASCADE;
DROP TABLE IF EXISTS announcement CASCADE;
DROP TABLE IF EXISTS favorite CASCADE;
DROP TABLE IF EXISTS book_digital_asset CASCADE;
DROP TABLE IF EXISTS book_copy CASCADE;
DROP TABLE IF EXISTS book_category CASCADE;
DROP TABLE IF EXISTS book CASCADE;
DROP TABLE IF EXISTS category CASCADE;
DROP TABLE IF EXISTS author CASCADE;
DROP TABLE IF EXISTS app_user CASCADE;

-- ============================================
-- TABELE GŁÓWNE
-- ============================================

-- Tabela: app_user - Użytkownicy systemu
CREATE TABLE app_user (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    email VARCHAR(180) NOT NULL,
    name VARCHAR(255) NOT NULL,
    roles JSON NOT NULL,
    password VARCHAR(255) NOT NULL,
    phone_number VARCHAR(30) DEFAULT NULL,
    address_line VARCHAR(255) DEFAULT NULL,
    city VARCHAR(120) DEFAULT NULL,
    postal_code VARCHAR(12) DEFAULT NULL,
    blocked BOOLEAN DEFAULT false NOT NULL,
    verified BOOLEAN DEFAULT false NOT NULL,
    verified_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    pending_approval BOOLEAN DEFAULT false NOT NULL,
    membership_group VARCHAR(64) DEFAULT 'standard' NOT NULL,
    loan_limit INT DEFAULT 5 NOT NULL,
    blocked_reason VARCHAR(255) DEFAULT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    updated_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    privacy_consent_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    newsletter_subscribed BOOLEAN DEFAULT true NOT NULL,
    preferred_categories JSON DEFAULT NULL,
    onboarding_completed BOOLEAN DEFAULT false NOT NULL,
    PRIMARY KEY(id)
);

CREATE UNIQUE INDEX UNIQ_88BDF3E9E7927C74 ON app_user (email);

-- Tabela: author - Autorzy książek
CREATE TABLE author (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    name VARCHAR(255) NOT NULL,
    PRIMARY KEY(id)
);

CREATE UNIQUE INDEX UNIQ_BDAFD8C85E237E06 ON author (name);

-- Tabela: category - Kategorie książek
CREATE TABLE category (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    name VARCHAR(120) NOT NULL,
    PRIMARY KEY(id)
);

CREATE UNIQUE INDEX UNIQ_64C19C15E237E06 ON category (name);

-- Tabela: book - Książki
CREATE TABLE book (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    title VARCHAR(255) NOT NULL,
    isbn VARCHAR(20) DEFAULT NULL,
    copies INT NOT NULL,
    total_copies INT NOT NULL,
    storage_copies INT NOT NULL,
    open_stack_copies INT NOT NULL,
    description TEXT DEFAULT NULL,
    publisher VARCHAR(180) DEFAULT NULL,
    publication_year SMALLINT DEFAULT NULL,
    resource_type VARCHAR(60) DEFAULT NULL,
    signature VARCHAR(60) DEFAULT NULL,
    target_age_group VARCHAR(24) DEFAULT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    author_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX IDX_CBE5A331F675F31B ON book (author_id);

-- Tabela: book_category - Relacja wiele do wielu między książkami a kategoriami
CREATE TABLE book_category (
    book_id INT NOT NULL,
    category_id INT NOT NULL,
    PRIMARY KEY(book_id, category_id)
);

CREATE INDEX IDX_1FB30F9816A2B381 ON book_category (book_id);
CREATE INDEX IDX_1FB30F9812469DE2 ON book_category (category_id);

-- Tabela: book_copy - Egzemplarze książek
CREATE TABLE book_copy (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    inventory_code VARCHAR(60) NOT NULL,
    status VARCHAR(20) NOT NULL,
    location VARCHAR(120) DEFAULT NULL,
    access_type VARCHAR(30) NOT NULL,
    condition_state VARCHAR(120) DEFAULT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    updated_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    book_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE UNIQUE INDEX UNIQ_5427F08A3DB3FFB6 ON book_copy (inventory_code);
CREATE INDEX IDX_5427F08A16A2B381 ON book_copy (book_id);

-- Tabela: book_digital_asset - Zasoby cyfrowe książek
CREATE TABLE book_digital_asset (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    label VARCHAR(255) NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    size INT NOT NULL,
    storage_name VARCHAR(255) NOT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    book_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE UNIQUE INDEX UNIQ_817C37D0570EB513 ON book_digital_asset (storage_name);
CREATE INDEX IDX_817C37D016A2B381 ON book_digital_asset (book_id);

-- ============================================
-- SYSTEM OCEN I REKOMENDACJI
-- ============================================

-- Tabela: rating - Oceny książek
CREATE TABLE rating (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    rating SMALLINT NOT NULL,
    review TEXT DEFAULT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    updated_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    user_id INT NOT NULL,
    book_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX IDX_D8892622A76ED395 ON rating (user_id);
CREATE INDEX IDX_D889262216A2B381 ON rating (book_id);
CREATE UNIQUE INDEX rating_user_book_unique ON rating (user_id, book_id);

-- Tabela: recommendation_feedback - Feedback użytkownika na rekomendacje
CREATE TABLE recommendation_feedback (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    feedback_type VARCHAR(20) NOT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    user_id INT NOT NULL,
    book_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX IDX_FEED_USER ON recommendation_feedback (user_id);
CREATE INDEX IDX_FEED_BOOK ON recommendation_feedback (book_id);
CREATE UNIQUE INDEX feedback_user_book_unique ON recommendation_feedback (user_id, book_id);

-- Tabela: book_collection - Kolekcje kuratorskie
CREATE TABLE book_collection (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT DEFAULT NULL,
    featured BOOLEAN NOT NULL,
    display_order INT NOT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    updated_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    curated_by_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX IDX_63E02F81436FBB41 ON book_collection (curated_by_id);

-- Tabela: collection_books - Relacja wiele do wielu między kolekcjami a książkami
CREATE TABLE collection_books (
    book_collection_id INT NOT NULL,
    book_id INT NOT NULL,
    PRIMARY KEY(book_collection_id, book_id)
);

CREATE INDEX IDX_DE392C134A06EF1 ON collection_books (book_collection_id);
CREATE INDEX IDX_DE392C116A2B381 ON collection_books (book_id);

-- ============================================
-- WYPOŻYCZENIA I REZERWACJE
-- ============================================

-- Tabela: loan - Wypożyczenia
CREATE TABLE loan (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    borrowed_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    due_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    returned_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    extensions_count INT NOT NULL,
    last_extended_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    book_id INT NOT NULL,
    book_copy_id INT DEFAULT NULL,
    user_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX IDX_C5D30D0316A2B381 ON loan (book_id);
CREATE INDEX IDX_C5D30D033B550FE4 ON loan (book_copy_id);
CREATE INDEX IDX_C5D30D03A76ED395 ON loan (user_id);

-- Tabela: reservation - Rezerwacje
CREATE TABLE reservation (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    status VARCHAR(20) NOT NULL,
    reserved_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    expires_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    fulfilled_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    cancelled_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    book_id INT NOT NULL,
    book_copy_id INT DEFAULT NULL,
    user_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX IDX_42C8495516A2B381 ON reservation (book_id);
CREATE INDEX IDX_42C849553B550FE4 ON reservation (book_copy_id);
CREATE INDEX IDX_42C84955A76ED395 ON reservation (user_id);

-- Tabela: fine - Kary/grzywny
CREATE TABLE fine (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    amount NUMERIC(8, 2) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    reason VARCHAR(255) NOT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    paid_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    loan_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX IDX_BEA95492CE73868F ON fine (loan_id);

-- ============================================
-- MODUŁ UŻYTKOWNIKÓW
-- ============================================

-- Tabela: favorite - Ulubione książki użytkowników
CREATE TABLE favorite (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    user_id INT NOT NULL,
    book_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX IDX_68C58ED9A76ED395 ON favorite (user_id);
CREATE INDEX IDX_68C58ED916A2B381 ON favorite (book_id);
CREATE UNIQUE INDEX favorite_user_book_unique ON favorite (user_id, book_id);

-- Tabela: registration_token - Tokeny rejestracyjne
CREATE TABLE registration_token (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    token VARCHAR(96) NOT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    expires_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    used_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    user_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE UNIQUE INDEX UNIQ_D09D01D35F37A13B ON registration_token (token);
CREATE INDEX IDX_D09D01D3A76ED395 ON registration_token (user_id);

-- ============================================
-- MODUŁ ADMINISTRACYJNY
-- ============================================

-- Tabela: announcement - Ogłoszenia
CREATE TABLE announcement (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    type VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL,
    is_pinned BOOLEAN NOT NULL,
    show_on_homepage BOOLEAN NOT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    updated_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    published_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    expires_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    target_audience JSON DEFAULT NULL,
    created_by_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX IDX_4DB9D91CB03A8386 ON announcement (created_by_id);

-- Tabela: audit_logs - Logi audytowe
CREATE TABLE audit_logs (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    entity_type VARCHAR(50) NOT NULL,
    entity_id INT DEFAULT NULL,
    action VARCHAR(20) NOT NULL,
    ip_address VARCHAR(45) DEFAULT NULL,
    old_values TEXT DEFAULT NULL,
    new_values TEXT DEFAULT NULL,
    description TEXT DEFAULT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    user_id INT DEFAULT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX idx_audit_entity ON audit_logs (entity_type, entity_id);
CREATE INDEX idx_audit_action ON audit_logs (action);
CREATE INDEX idx_audit_user ON audit_logs (user_id);
CREATE INDEX idx_audit_created ON audit_logs (created_at);

-- Tabela: backup_record - Rekordy kopii zapasowych
CREATE TABLE backup_record (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    file_name VARCHAR(190) NOT NULL,
    file_path VARCHAR(255) NOT NULL,
    file_size INT NOT NULL,
    status VARCHAR(32) NOT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    initiated_by VARCHAR(120) DEFAULT NULL,
    PRIMARY KEY(id)
);

-- ============================================
-- MODUŁ INTEGRACJI
-- ============================================

-- Tabela: integration_config - Konfiguracje integracji
CREATE TABLE integration_config (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    name VARCHAR(160) NOT NULL,
    provider VARCHAR(120) NOT NULL,
    enabled BOOLEAN NOT NULL,
    settings JSON NOT NULL,
    last_status VARCHAR(32) NOT NULL,
    last_tested_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    updated_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    PRIMARY KEY(id)
);

-- Tabela: notification_log - Logi powiadomień
CREATE TABLE notification_log (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    type VARCHAR(64) NOT NULL,
    channel VARCHAR(32) NOT NULL,
    fingerprint VARCHAR(96) NOT NULL,
    payload JSON DEFAULT NULL,
    status VARCHAR(32) NOT NULL,
    error_message VARCHAR(255) DEFAULT NULL,
    sent_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    user_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX IDX_ED15DF2A76ED395 ON notification_log (user_id);
CREATE UNIQUE INDEX uq_notification_fingerprint_channel ON notification_log (fingerprint, channel);

-- ============================================
-- MODUŁ AKWIZYCJI
-- ============================================

-- Tabela: supplier - Dostawcy
CREATE TABLE supplier (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    name VARCHAR(255) NOT NULL,
    contact_person VARCHAR(180) DEFAULT NULL,
    email VARCHAR(180) DEFAULT NULL,
    phone VARCHAR(30) DEFAULT NULL,
    address TEXT DEFAULT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    updated_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    PRIMARY KEY(id)
);

-- Tabela: acquisition_budget - Budżety akwizycji
CREATE TABLE acquisition_budget (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    name VARCHAR(160) NOT NULL,
    fiscal_year VARCHAR(9) NOT NULL,
    allocated_amount NUMERIC(12, 2) NOT NULL,
    spent_amount NUMERIC(12, 2) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    updated_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    PRIMARY KEY(id)
);

-- Tabela: acquisition_order - Zamówienia akwizycyjne
CREATE TABLE acquisition_order (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    reference_number VARCHAR(120) DEFAULT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT DEFAULT NULL,
    items JSON DEFAULT NULL,
    total_amount NUMERIC(12, 2) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    updated_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    ordered_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    expected_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    received_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    cancelled_at TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT NULL,
    supplier_id INT NOT NULL,
    budget_id INT DEFAULT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX IDX_1E96EAF32ADD6D8C ON acquisition_order (supplier_id);
CREATE INDEX IDX_1E96EAF336ABA6B8 ON acquisition_order (budget_id);

-- Tabela: acquisition_expense - Wydatki akwizycyjne
CREATE TABLE acquisition_expense (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    amount NUMERIC(12, 2) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    description VARCHAR(255) NOT NULL,
    type VARCHAR(20) NOT NULL,
    posted_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    budget_id INT NOT NULL,
    order_id INT DEFAULT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX IDX_82EA1DED36ABA6B8 ON acquisition_expense (budget_id);
CREATE INDEX IDX_82EA1DED8D9F6D38 ON acquisition_expense (order_id);

-- Tabela: weeding_record - Rekordy selekcji zbiorów
CREATE TABLE weeding_record (
    id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    reason VARCHAR(255) NOT NULL,
    weeded_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    book_copy_id INT NOT NULL,
    performed_by_id INT NOT NULL,
    PRIMARY KEY(id)
);

CREATE INDEX IDX_WR_COPY ON weeding_record (book_copy_id);
CREATE INDEX IDX_WR_PERFORMED_BY ON weeding_record (performed_by_id);

-- ============================================
-- KLUCZE OBCE
-- ============================================

ALTER TABLE book ADD CONSTRAINT FK_CBE5A331F675F31B FOREIGN KEY (author_id) REFERENCES author (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE book_category ADD CONSTRAINT FK_1FB30F9816A2B381 FOREIGN KEY (book_id) REFERENCES book (id) ON DELETE CASCADE NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE book_category ADD CONSTRAINT FK_1FB30F9812469DE2 FOREIGN KEY (category_id) REFERENCES category (id) ON DELETE CASCADE NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE book_copy ADD CONSTRAINT FK_5427F08A16A2B381 FOREIGN KEY (book_id) REFERENCES book (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE book_digital_asset ADD CONSTRAINT FK_817C37D016A2B381 FOREIGN KEY (book_id) REFERENCES book (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE rating ADD CONSTRAINT FK_D8892622A76ED395 FOREIGN KEY (user_id) REFERENCES app_user (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE rating ADD CONSTRAINT FK_D889262216A2B381 FOREIGN KEY (book_id) REFERENCES book (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE recommendation_feedback ADD CONSTRAINT FK_FEED_USER FOREIGN KEY (user_id) REFERENCES app_user (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE recommendation_feedback ADD CONSTRAINT FK_FEED_BOOK FOREIGN KEY (book_id) REFERENCES book (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE book_collection ADD CONSTRAINT FK_63E02F81436FBB41 FOREIGN KEY (curated_by_id) REFERENCES app_user (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE collection_books ADD CONSTRAINT FK_DE392C134A06EF1 FOREIGN KEY (book_collection_id) REFERENCES book_collection (id) ON DELETE CASCADE NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE collection_books ADD CONSTRAINT FK_DE392C116A2B381 FOREIGN KEY (book_id) REFERENCES book (id) ON DELETE CASCADE NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE loan ADD CONSTRAINT FK_C5D30D0316A2B381 FOREIGN KEY (book_id) REFERENCES book (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE loan ADD CONSTRAINT FK_C5D30D033B550FE4 FOREIGN KEY (book_copy_id) REFERENCES book_copy (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE loan ADD CONSTRAINT FK_C5D30D03A76ED395 FOREIGN KEY (user_id) REFERENCES app_user (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE reservation ADD CONSTRAINT FK_42C8495516A2B381 FOREIGN KEY (book_id) REFERENCES book (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE reservation ADD CONSTRAINT FK_42C849553B550FE4 FOREIGN KEY (book_copy_id) REFERENCES book_copy (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE reservation ADD CONSTRAINT FK_42C84955A76ED395 FOREIGN KEY (user_id) REFERENCES app_user (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE fine ADD CONSTRAINT FK_BEA95492CE73868F FOREIGN KEY (loan_id) REFERENCES loan (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE favorite ADD CONSTRAINT FK_68C58ED9A76ED395 FOREIGN KEY (user_id) REFERENCES app_user (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE favorite ADD CONSTRAINT FK_68C58ED916A2B381 FOREIGN KEY (book_id) REFERENCES book (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE registration_token ADD CONSTRAINT FK_D09D01D3A76ED395 FOREIGN KEY (user_id) REFERENCES app_user (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE announcement ADD CONSTRAINT FK_4DB9D91CB03A8386 FOREIGN KEY (created_by_id) REFERENCES app_user (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE notification_log ADD CONSTRAINT FK_ED15DF2A76ED395 FOREIGN KEY (user_id) REFERENCES app_user (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE acquisition_order ADD CONSTRAINT FK_1E96EAF32ADD6D8C FOREIGN KEY (supplier_id) REFERENCES supplier (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE acquisition_order ADD CONSTRAINT FK_1E96EAF336ABA6B8 FOREIGN KEY (budget_id) REFERENCES acquisition_budget (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE acquisition_expense ADD CONSTRAINT FK_82EA1DED36ABA6B8 FOREIGN KEY (budget_id) REFERENCES acquisition_budget (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE acquisition_expense ADD CONSTRAINT FK_82EA1DED8D9F6D38 FOREIGN KEY (order_id) REFERENCES acquisition_order (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE weeding_record ADD CONSTRAINT FK_WR_COPY FOREIGN KEY (book_copy_id) REFERENCES book_copy (id) NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE weeding_record ADD CONSTRAINT FK_WR_PERFORMED_BY FOREIGN KEY (performed_by_id) REFERENCES app_user (id) NOT DEFERRABLE INITIALLY IMMEDIATE;

-- ============================================
-- DANE TESTOWE
-- ============================================

\echo 'Inserting test data...'

-- Użytkownicy
INSERT INTO app_user (id, email, name, roles, password, phone_number, city, blocked, verified, verified_at, pending_approval, membership_group, loan_limit, created_at, updated_at, privacy_consent_at, newsletter_subscribed, preferred_categories, onboarding_completed) VALUES
(1, 'admin@biblioteka.pl', 'Administrator', '["ROLE_ADMIN"]', '$2y$13$Xhz8P0vQ.zKL9XGkYPfcReZE8QYj1MJOvGk.W7nRZ7I8x5YqzLVnm', '+48123456789', 'Warszawa', false, true, NOW(), false, 'admin', 999, NOW(), NOW(), NOW(), true, NULL, true),
(2, 'librarian@biblioteka.pl', 'Jan Kowalski', '["ROLE_LIBRARIAN"]', '$2y$13$Xhz8P0vQ.zKL9XGkYPfcReZE8QYj1MJOvGk.W7nRZ7I8x5YqzLVnm', '+48234567890', 'Warszawa', false, true, NOW(), false, 'staff', 50, NOW(), NOW(), NOW(), true, NULL, true),
(3, 'user@example.com', 'Anna Nowak', '["ROLE_USER"]', '$2y$13$Xhz8P0vQ.zKL9XGkYPfcReZE8QYj1MJOvGk.W7nRZ7I8x5YqzLVnm', '+48345678901', 'Kraków', false, true, NOW(), false, 'standard', 5, NOW(), NOW(), NOW(), true, '[4, 5, 7]', true),
(4, 'jan.student@example.com', 'Jan Student', '["ROLE_USER"]', '$2y$13$Xhz8P0vQ.zKL9XGkYPfcReZE8QYj1MJOvGk.W7nRZ7I8x5YqzLVnm', NULL, 'Gdańsk', false, true, NOW(), false, 'student', 10, NOW(), NOW(), NOW(), false, '[6, 9]', false),
(5, 'maria.reader@example.com', 'Maria Czytelnik', '["ROLE_USER"]', '$2y$13$Xhz8P0vQ.zKL9XGkYPfcReZE8QYj1MJOvGk.W7nRZ7I8x5YqzLVnm', '+48456789012', 'Wrocław', false, true, NOW(), false, 'premium', 15, NOW(), NOW(), NOW(), true, '[4, 5]', true);

-- Autorzy
INSERT INTO author (id, name) VALUES
(1, 'Andrzej Sapkowski'),
(2, 'Olga Tokarczuk'),
(3, 'Stanisław Lem'),
(4, 'Ryszard Kapuściński'),
(5, 'Wisława Szymborska'),
(6, 'Henryk Sienkiewicz'),
(7, 'Czesław Miłosz'),
(8, 'J.K. Rowling'),
(9, 'George Orwell'),
(10, 'Isaac Asimov');

-- Kategorie
INSERT INTO category (id, name) VALUES
(1, 'Fantastyka'),
(2, 'Literatura piękna'),
(3, 'Poezja'),
(4, 'Science Fiction'),
(5, 'Fantasy'),
(6, 'Literatura faktu'),
(7, 'Technologia'),
(8, 'Historia'),
(9, 'Kryminał'),
(10, 'Romans');

-- Książki
INSERT INTO book (id, title, isbn, author_id, copies, total_copies, storage_copies, open_stack_copies, description, publisher, publication_year, resource_type, signature, target_age_group, created_at) VALUES
(1, 'Wiedźmin: Ostatnie życzenie', '978-83-7469-627-4', 1, 5, 5, 3, 2, 'Pierwszy tom sagi o wiedźminie Geralcie z Rivii.', 'SuperNOWA', 1993, 'Książka drukowana', 'F-SAP-001', 'adult', NOW()),
(2, 'Księgi Jakubowe', '978-83-08-06384-6', 2, 3, 3, 2, 1, 'Powieść o życiu Jakuba Franka i jego wyznawców.', 'Wydawnictwo Literackie', 2014, 'Książka drukowana', 'L-TOK-001', 'adult', NOW()),
(3, 'Solaris', '978-83-7506-127-3', 3, 4, 4, 2, 2, 'Klasyka science fiction o kontakcie z obcą inteligencją.', 'Wydawnictwo Literackie', 1961, 'Książka drukowana', 'SF-LEM-001', 'adult', NOW()),
(4, 'Imperium', '978-83-240-0942-7', 4, 2, 2, 1, 1, 'Reportaż o ostatnich dniach ZSRR.', 'Czytelnik', 1993, 'Książka drukowana', 'R-KAP-001', 'adult', NOW()),
(5, 'Sto pociech', '978-83-08-03371-9', 5, 2, 2, 2, 0, 'Zbiór wierszy noblistki.', 'Wydawnictwo a5', 1967, 'Książka drukowana', 'P-SZY-001', 'adult', NOW()),
(6, 'Quo Vadis', '978-83-240-1234-5', 6, 6, 6, 4, 2, 'Powieść historyczna z czasów Nerona.', 'Czytelnik', 1896, 'Książka drukowana', 'H-SIE-001', 'teen', NOW()),
(7, 'Zniewolony umysł', '978-83-08-04567-8', 7, 3, 3, 2, 1, 'Esej o intelektualistach w PRL.', 'Instytut Literacki', 1953, 'Książka drukowana', 'E-MIL-001', 'adult', NOW()),
(8, 'Harry Potter i Kamień Filozoficzny', '978-83-7327-823-4', 8, 8, 8, 4, 4, 'Pierwsza część przygód młodego czarodzieja.', 'Media Rodzina', 1997, 'E-book', 'F-ROW-001', 'child', NOW()),
(9, 'Rok 1984', '978-83-240-5678-9', 9, 5, 5, 3, 2, 'Dystopia o totalitaryzmie.', 'Muza', 1949, 'Książka drukowana', 'SF-ORW-001', 'adult', NOW()),
(10, 'Fundacja', '978-83-7469-234-5', 10, 4, 4, 2, 2, 'Pierwszy tom cyklu o upadku i odrodzeniu galaktycznego imperium.', 'Zysk i S-ka', 1951, 'Książka drukowana', 'SF-ASI-001', 'teen', NOW());

-- Relacje książka-kategoria
INSERT INTO book_category (book_id, category_id) VALUES
(1, 1), (1, 5),
(2, 2), (2, 8),
(3, 4), (3, 1),
(4, 6), (4, 8),
(5, 3), (5, 2),
(6, 8), (6, 2),
(7, 6), (7, 8),
(8, 5), (8, 1),
(9, 4), (9, 1),
(10, 4), (10, 1);

-- Egzemplarze książek
INSERT INTO book_copy (id, book_id, inventory_code, status, location, access_type, condition_state, created_at, updated_at) VALUES
(1, 1, 'INV-001-001', 'available', 'Magazyn A1', 'open_stack', 'Dobry', NOW(), NOW()),
(2, 1, 'INV-001-002', 'available', 'Półka główna', 'open_stack', 'Bardzo dobry', NOW(), NOW()),
(3, 1, 'INV-001-003', 'loaned', 'Wypożyczona', 'open_stack', 'Dobry', NOW(), NOW()),
(4, 2, 'INV-002-001', 'available', 'Magazyn B2', 'closed_stack', 'Dobry', NOW(), NOW()),
(5, 3, 'INV-003-001', 'available', 'Półka SF', 'open_stack', 'Bardzo dobry', NOW(), NOW()),
(6, 3, 'INV-003-002', 'available', 'Półka SF', 'open_stack', 'Dobry', NOW(), NOW()),
(7, 8, 'INV-008-001', 'available', 'Cyfrowy', 'digital', 'Nieaplikowalny', NOW(), NOW()),
(8, 9, 'INV-009-001', 'available', 'Półka dystopie', 'open_stack', 'Dobry', NOW(), NOW());

-- Wypożyczenia
INSERT INTO loan (id, book_id, book_copy_id, user_id, borrowed_at, due_at, returned_at, extensions_count, last_extended_at) VALUES
(1, 1, 3, 3, NOW() - INTERVAL '10 days', NOW() + INTERVAL '20 days', NULL, 0, NULL),
(2, 6, NULL, 4, NOW() - INTERVAL '25 days', NOW() - INTERVAL '5 days', NOW() - INTERVAL '3 days', 1, NOW() - INTERVAL '15 days');

-- Ulubione
INSERT INTO favorite (id, user_id, book_id, created_at) VALUES
(1, 3, 1, NOW()),
(2, 3, 3, NOW()),
(3, 3, 8, NOW()),
(4, 4, 8, NOW()),
(5, 5, 2, NOW());

-- Oceny książek
INSERT INTO rating (id, user_id, book_id, rating, review, created_at, updated_at) VALUES
(1, 3, 1, 5, 'Fantastyczna książka! Nie mogłem się oderwać.', NOW() - INTERVAL '5 days', NULL),
(2, 3, 3, 4, 'Klasyka SF, choć trochę wolna w tempie.', NOW() - INTERVAL '3 days', NULL),
(3, 4, 8, 5, 'Magiczny świat, świetna dla dzieci i dorosłych!', NOW() - INTERVAL '2 days', NULL),
(4, 5, 2, 5, 'Arcydzieło polskiej literatury.', NOW() - INTERVAL '1 day', NULL),
(5, 5, 9, 4, 'Przerażająco aktualna wizja przyszłości.', NOW(), NULL);

-- Kolekcje kuratorskie
INSERT INTO book_collection (id, name, description, featured, display_order, curated_by_id, created_at, updated_at) VALUES
(1, 'Klasyka Polskiej Fantastyki', 'Najlepsze dzieła polskich autorów fantasy i SF', true, 1, 2, NOW(), NULL),
(2, 'Laureaci Nobla', 'Książki autorów nagrodzonych Nagrodą Nobla w dziedzinie literatury', true, 2, 2, NOW(), NULL),
(3, 'Dla Młodych Czytelników', 'Najlepsze książki dla dzieci i młodzieży', false, 3, 2, NOW(), NULL);

-- Relacje kolekcja-książki
INSERT INTO collection_books (book_collection_id, book_id) VALUES
(1, 1), (1, 3),
(2, 2), (2, 5), (2, 7),
(3, 8), (3, 6);

-- Feedback rekomendacji
INSERT INTO recommendation_feedback (id, user_id, book_id, feedback_type, created_at) VALUES
(1, 3, 4, 'dismiss', NOW() - INTERVAL '2 days'),
(2, 4, 10, 'interested', NOW() - INTERVAL '1 day');

-- Ogłoszenia
INSERT INTO announcement (id, title, content, type, status, is_pinned, show_on_homepage, created_by_id, created_at, updated_at, published_at, expires_at, target_audience) VALUES
(1, 'Nowe godziny otwarcia', 'Od przyszłego tygodnia biblioteka będzie czynna w soboty do godziny 18:00.', 'info', 'published', true, true, 1, NOW() - INTERVAL '7 days', NOW() - INTERVAL '7 days', NOW() - INTERVAL '7 days', NOW() + INTERVAL '30 days', '["all"]'),
(2, 'Konkurs literacki', 'Zapraszamy do udziału w konkursie na najlepszą recenzję książki!', 'event', 'published', false, true, 2, NOW() - INTERVAL '3 days', NOW() - INTERVAL '3 days', NOW() - INTERVAL '3 days', NOW() + INTERVAL '60 days', '["ROLE_USER"]');

-- Resetowanie sekwencji
SELECT setval('app_user_id_seq', (SELECT MAX(id) FROM app_user));
SELECT setval('author_id_seq', (SELECT MAX(id) FROM author));
SELECT setval('category_id_seq', (SELECT MAX(id) FROM category));
SELECT setval('book_id_seq', (SELECT MAX(id) FROM book));
SELECT setval('book_copy_id_seq', (SELECT MAX(id) FROM book_copy));
SELECT setval('loan_id_seq', (SELECT MAX(id) FROM loan));
SELECT setval('favorite_id_seq', (SELECT MAX(id) FROM favorite));
SELECT setval('announcement_id_seq', (SELECT MAX(id) FROM announcement) + 1);

\echo 'Schema and test data created successfully!'
\echo 'Test users:'
\echo '  admin@biblioteka.pl - Administrator (ROLE_ADMIN)'
\echo '  librarian@biblioteka.pl - Bibliotekarz (ROLE_LIBRARIAN)'
\echo '  user@example.com - Użytkownik (ROLE_USER)'
\echo 'Default password for all: password123'
\echo ''
\echo 'Database includes:'
\echo '  - 5 users (1 admin, 1 librarian, 3 readers)'
\echo '  - 10 authors'
\echo '  - 10 categories'
\echo '  - 10 books with categories'
\echo '  - 8 book copies'
\echo '  - 2 loans (1 active, 1 returned)'
\echo '  - 5 favorites'
\echo '  - 5 book ratings'
\echo '  - 3 curated collections'
\echo '  - 2 recommendation feedbacks'
\echo '  - 2 announcements'
