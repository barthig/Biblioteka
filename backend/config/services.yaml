parameters:
  locale: 'pl'
  app.notifications.from: 'no-reply@biblioteka.local'

services:
  _defaults:
    autowire: true
    autoconfigure: true

  App\:
    resource: '../src/'
    exclude:
      - '../src/DataFixtures/'
      - '../src/Entity/'
      - '../src/Kernel.php'

  # Service aliases (mapping legacy App\Service\X to actual subfolder locations)
  App\Service\SecurityService: '@App\Service\Auth\SecurityService'
  App\Service\JwtService: '@App\Service\Auth\JwtService'
  App\Service\RefreshTokenService: '@App\Service\Auth\RefreshTokenService'
  App\Service\RegistrationService: '@App\Service\Auth\RegistrationService'
  App\Service\NotificationService: '@App\Service\User\NotificationService'
  App\Service\BookService: '@App\Service\Book\BookService'
  App\Service\BookCacheService: '@App\Service\Book\BookCacheService'
  App\Service\OpenAIEmbeddingService: '@App\Service\Book\OpenAIEmbeddingService'
  App\Service\PersonalizedRecommendationService: '@App\Service\Book\PersonalizedRecommendationService'
  App\Service\RecommendationService: '@App\Service\Book\RecommendationService'
  App\Service\SystemSettingsService: '@App\Service\System\SystemSettingsService'
  App\Service\AuditService: '@App\Service\System\AuditService'
  App\Service\BackupService: '@App\Service\System\BackupService'
  App\Service\ElasticsearchService: '@App\Service\System\ElasticsearchService'
  App\Service\StatisticsCacheService: '@App\Service\System\StatisticsCacheService'
  App\Service\FeeService: '@App\Service\Loan\FeeService'
  App\Service\ReservationService: '@App\Service\Loan\ReservationService'
  App\Service\IsbnImportService: '@App\Service\Maintenance\IsbnImportService'
  App\Service\PatronAnonymizer: '@App\Service\Maintenance\PatronAnonymizer'
  App\Service\WeedingAnalyticsService: '@App\Service\Maintenance\WeedingAnalyticsService'
  App\Service\NewsletterComposer: '@App\Service\Notification\NewsletterComposer'
  App\Service\NotificationSender: '@App\Service\Notification\NotificationSender'

  # Force handler namespaces onto dedicated buses
  App\Application\Handler\Command\:
    resource: '../src/Application/Handler/Command'
    tags:
      - { name: messenger.message_handler, bus: command.bus }

  App\Application\Handler\Query\:
    resource: '../src/Application/Handler/Query'
    tags:
      - { name: messenger.message_handler, bus: query.bus }

  # Legacy QueryHandler namespace removed — all handlers moved to Handler\Query\

  App\DataFixtures\:
    resource: '../src/DataFixtures/'
    tags: ['doctrine.fixture.orm']

  App\Service\Notification\NotificationSender:
    arguments:
      $fromAddress: '%app.notifications.from%'

  App\MessageHandler\ReservationQueuedNotificationHandler:
    arguments:
      $projectDir: '%kernel.project_dir%'
    tags: ['messenger.message_handler']

  App\EventSubscriber\ApiAuthSubscriber:
    arguments:
      $users: '@App\Repository\UserRepository'
      $tokenStorage: '@security.token_storage'
    tags: ['kernel.event_subscriber']
  
  # Named Rate Limiters
  App\Controller\Auth\AuthController:
    arguments:
      $loginAttemptsLimiter: '@limiter.login_attempts'
  
  App\Controller\Auth\RegistrationController:
    arguments:
      $registrationAttemptsLimiter: '@limiter.registration_attempts'
  
  # CQRS Buses - Loans
  App\Controller\Loans\LoanController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'
  
  App\Controller\Loans\ReservationController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\Loans\FineController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  # CQRS Buses - Books
  App\Controller\Books\BookController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  # CQRS Buses - User
  App\Controller\User\UserManagementController:
    arguments:
      $commandBus: '@command.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\AdminUserController:
    arguments:
      $commandBus: '@command.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\User\UserController:
    arguments:
      $messageBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\User\AccountController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\User\FavoriteController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\Books\ReviewController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\DashboardController:
    arguments:
      $security: '@App\Service\SecurityService'
      $queryBus: '@query.bus'

  App\Controller\ReportController:
    arguments:
      $queryBus: '@query.bus'

  App\Controller\AuditLogController:
    arguments:
      $queryBus: '@query.bus'

  App\Controller\Catalog\CatalogAdminController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\Books\BookInventoryController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\Books\BookAssetController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\Books\WeedingController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\Catalog\AnnouncementController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\AcquisitionBudgetController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\AcquisitionOrderController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\AcquisitionSupplierController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\Books\CollectionController:
    arguments:
      $commandBus: '@command.bus'

  App\Controller\Books\RatingController:
    arguments:
      $commandBus: '@command.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\Books\RecommendationFeedbackController:
    arguments:
      $commandBus: '@command.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\AlertController:
    arguments:
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\User\NotificationController:
    arguments:
      $security: '@App\Service\SecurityService'
      $notificationLogs: '@App\Repository\NotificationLogRepository'
      $entityManager: '@doctrine.orm.entity_manager'

  App\Controller\Admin\RoleAdminController:
    arguments:
      $commandBus: '@command.bus'

  App\Controller\StaffRoleController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'

  App\Controller\SystemSettingController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'

  App\Controller\IntegrationConfigController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'

  App\Controller\Admin\IntegrationAdminController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'

  App\Controller\Admin\SystemConfigController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'

  App\ApiDoc\DefaultOperationDescriber:
    tags:
      - { name: nelmio_api_doc.describer, priority: -2000 }

  App\ApiDoc\RouteOperationDescriber:
    tags:
      - { name: nelmio_api_doc.describer, priority: -1500 }

  # ─── Integration Events (distributed architecture) ───
  App\Service\Integration\IntegrationEventPublisher:
    arguments:
      $amqpConnection: '@app.amqp_connection'
      $exchange: 'biblioteka.events'

  app.amqp_connection:
    class: PhpAmqpLib\Connection\AMQPStreamConnection
    factory: ['App\Service\Integration\AmqpConnectionFactory', 'create']
    arguments:
      $dsn: '%env(MESSENGER_TRANSPORT_DSN)%'

  App\EventSubscriber\IntegrationEventBridgeSubscriber:
    tags: ['kernel.event_subscriber']

  # Distributed health check — inject Predis client
  app.redis_client:
    class: Predis\Client
    arguments:
      - '%env(REDIS_URL)%'

  App\Controller\DistributedHealthController:
    arguments:
      $redis: '@app.redis_client'
