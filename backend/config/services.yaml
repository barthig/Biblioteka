parameters:
  locale: 'pl'
  app.notifications.from: 'no-reply@biblioteka.local'

services:
  _defaults:
    autowire: true
    autoconfigure: true

  App\:
    resource: '../src/'
    exclude:
      - '../src/DataFixtures/'
      - '../src/Entity/'
      - '../src/Kernel.php'

  # Force handler namespaces onto dedicated buses
  App\Application\Handler\Command\:
    resource: '../src/Application/Handler/Command'
    tags:
      - { name: messenger.message_handler, bus: command.bus }

  App\Application\Handler\Query\:
    resource: '../src/Application/Handler/Query'
    tags:
      - { name: messenger.message_handler, bus: query.bus }

  # Legacy QueryHandler namespace - ensure it also runs on the query bus
  App\Application\QueryHandler\:
    resource: '../src/Application/QueryHandler'
    tags:
      - { name: messenger.message_handler, bus: query.bus }

  App\DataFixtures\:
    resource: '../src/DataFixtures/'
    tags: ['doctrine.fixture.orm']

  App\Service\Notification\NotificationSender:
    arguments:
      $fromAddress: '%app.notifications.from%'

  App\MessageHandler\ReservationQueuedNotificationHandler:
    arguments:
      $projectDir: '%kernel.project_dir%'
    tags: ['messenger.message_handler']

  App\EventSubscriber\ApiAuthSubscriber:
    arguments:
      $users: '@App\Repository\UserRepository'
      $tokenStorage: '@security.token_storage'
    tags: ['kernel.event_subscriber']
  
  # Named Rate Limiters
  App\Controller\AuthController:
    arguments:
      $loginAttemptsLimiter: '@limiter.login_attempts'
  
  App\Controller\RegistrationController:
    arguments:
      $registrationAttemptsLimiter: '@limiter.registration_attempts'
  
  # CQRS Buses
  App\Controller\LoanController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'
  
  App\Controller\ReservationController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\FineController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\BookController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\UserManagementController:
    arguments:
      $commandBus: '@command.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\AdminUserController:
    arguments:
      $commandBus: '@command.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\AccountController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\FavoriteController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\ReviewController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\DashboardController:
    arguments:
      $security: '@App\Service\SecurityService'
      $queryBus: '@query.bus'

  App\Controller\ReportController:
    arguments:
      $queryBus: '@query.bus'

  App\Controller\AuditLogController:
    arguments:
      $queryBus: '@query.bus'

  App\Controller\CatalogAdminController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\BookInventoryController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\BookAssetController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\WeedingController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\AnnouncementController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\AcquisitionBudgetController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\AcquisitionOrderController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\AcquisitionSupplierController:
    arguments:
      $queryBus: '@query.bus'
      $commandBus: '@command.bus'

  App\Controller\CollectionController:
    arguments:
      $commandBus: '@command.bus'

  App\Controller\RatingController:
    arguments:
      $commandBus: '@command.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\RecommendationFeedbackController:
    arguments:
      $commandBus: '@command.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\AlertController:
    arguments:
      $queryBus: '@query.bus'
      $security: '@App\Service\SecurityService'

  App\Controller\Admin\RoleAdminController:
    arguments:
      $commandBus: '@command.bus'

  App\Controller\Admin\IntegrationAdminController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'

  App\Controller\Admin\SystemConfigController:
    arguments:
      $commandBus: '@command.bus'
      $queryBus: '@query.bus'

  App\ApiDoc\DefaultOperationDescriber:
    tags:
      - { name: nelmio_api_doc.describer, priority: -2000 }

  App\ApiDoc\RouteOperationDescriber:
    tags:
      - { name: nelmio_api_doc.describer, priority: -1500 }
